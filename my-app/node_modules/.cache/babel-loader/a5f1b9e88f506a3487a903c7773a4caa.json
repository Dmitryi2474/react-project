{"ast":null,"code":"var Immutable = require(\"immutable\");\n\n/**\n * Track connected clients\n * @param {UI} ui\n * @param {BrowserSync} bs\n */\nmodule.exports.init = function (ui, bs) {\n  var uaParser = new bs.utils.UAParser();\n  var currentConnections = [];\n  ui.clients.on(\"connection\", function (client) {\n    client.on(\"client:heartbeat\", function (data) {\n      var match;\n      if (currentConnections.some(function (item, index) {\n        if (item.id === client.id) {\n          match = index;\n          return true;\n        }\n        return false;\n      })) {\n        if (typeof match === \"number\") {\n          currentConnections[match].timestamp = new Date().getTime();\n          currentConnections[match].data = data;\n        }\n      } else {\n        currentConnections.push({\n          id: client.id,\n          timestamp: new Date().getTime(),\n          browser: uaParser.setUA(client.handshake.headers[\"user-agent\"]).getBrowser(),\n          data: data\n        });\n      }\n    });\n  });\n  var registry;\n  var temp;\n  var initialSent;\n  var int = setInterval(function () {\n    var sockets = ui.clients.sockets;\n    var keys = Object.keys(sockets);\n    if (keys.length) {\n      temp = Immutable.List(keys.map(function (clientKey) {\n        var currentClient = sockets[clientKey];\n        return Immutable.fromJS({\n          id: currentClient.id,\n          browser: uaParser.setUA(currentClient.handshake.headers[\"user-agent\"]).getBrowser()\n        });\n      }));\n      if (!registry) {\n        registry = temp;\n        sendUpdated(ui.socket, decorateClients(registry.toJS(), currentConnections));\n      } else {\n        if (Immutable.is(registry, temp)) {\n          if (!initialSent) {\n            sendUpdated(ui.socket, decorateClients(registry.toJS(), currentConnections));\n            initialSent = true;\n          }\n        } else {\n          registry = temp;\n          sendUpdated(ui.socket, decorateClients(registry.toJS(), currentConnections));\n        }\n      }\n    } else {\n      sendUpdated(ui.socket, []);\n    }\n  }, 1000);\n  bs.registerCleanupTask(function () {\n    clearInterval(int);\n  });\n};\n\n/**\n * Use heart-beated data to decorate clients\n * @param clients\n * @param clientsInfo\n * @returns {*}\n */\nfunction decorateClients(clients, clientsInfo) {\n  return clients.map(function (item) {\n    clientsInfo.forEach(function (client) {\n      if (client.id === item.id) {\n        item.data = client.data;\n        return false;\n      }\n    });\n    return item;\n  });\n}\n\n/**\n * @param socket\n * @param connectedClients\n */\nfunction sendUpdated(socket, connectedClients) {\n  socket.emit(\"ui:connections:update\", connectedClients);\n}\n\n/**\n * @param clients\n * @param data\n */\n//function highlightClient (clients, data) {\n//    var socket = getClientById(clients, data.id);\n//    if (socket) {\n//        socket.emit(\"highlight\");\n//    }\n//}\n\n/**\n * @param clients\n * @param id\n */\n//function getClientById (clients, id) {\n//    var match;\n//    clients.sockets.some(function (item, i) {\n//        if (item.id === id) {\n//            match = clients.sockets[i];\n//            return true;\n//        }\n//    });\n//    return match;\n//}","map":{"version":3,"names":["Immutable","require","module","exports","init","ui","bs","uaParser","utils","UAParser","currentConnections","clients","on","client","data","match","some","item","index","id","timestamp","Date","getTime","push","browser","setUA","handshake","headers","getBrowser","registry","temp","initialSent","int","setInterval","sockets","keys","Object","length","List","map","clientKey","currentClient","fromJS","sendUpdated","socket","decorateClients","toJS","is","registerCleanupTask","clearInterval","clientsInfo","forEach","connectedClients","emit"],"sources":["/home/user/Рабочий стол/pizza/project/node_modules/browser-sync-ui/lib/plugins/connections/lib/connections.js"],"sourcesContent":["var Immutable = require(\"immutable\");\n\n/**\n * Track connected clients\n * @param {UI} ui\n * @param {BrowserSync} bs\n */\nmodule.exports.init = function (ui, bs) {\n\n    var uaParser = new bs.utils.UAParser();\n\n    var currentConnections = [];\n\n    ui.clients.on(\"connection\", function (client) {\n        client.on(\"client:heartbeat\", function (data) {\n            var match;\n            if (currentConnections.some(function (item, index) {\n                    if (item.id === client.id) {\n                        match = index;\n                        return true;\n                    }\n                    return false;\n                })) {\n                if (typeof match === \"number\") {\n                    currentConnections[match].timestamp = new Date().getTime();\n                    currentConnections[match].data = data;\n                }\n            } else {\n                currentConnections.push({\n                    id: client.id,\n                    timestamp: new Date().getTime(),\n                    browser: uaParser.setUA(client.handshake.headers[\"user-agent\"]).getBrowser(),\n                    data: data\n                });\n            }\n        });\n    });\n\n    var registry;\n    var temp;\n    var initialSent;\n\n    var int = setInterval(function () {\n\n        var sockets = ui.clients.sockets;\n        var keys = Object.keys(sockets);\n\n        if (keys.length) {\n            temp = Immutable.List(keys.map(function (clientKey) {\n                var currentClient = sockets[clientKey];\n                return Immutable.fromJS({\n                    id: currentClient.id,\n                    browser: uaParser.setUA(currentClient.handshake.headers[\"user-agent\"]).getBrowser()\n                });\n            }));\n            if (!registry) {\n                registry = temp;\n                sendUpdated(ui.socket, decorateClients(registry.toJS(), currentConnections));\n            } else {\n                if (Immutable.is(registry, temp)) {\n                    if (!initialSent) {\n                        sendUpdated(ui.socket, decorateClients(registry.toJS(), currentConnections));\n                        initialSent = true;\n                    }\n                } else {\n                    registry = temp;\n                    sendUpdated(ui.socket, decorateClients(registry.toJS(), currentConnections));\n                }\n            }\n        } else {\n            sendUpdated(ui.socket, []);\n        }\n\n    }, 1000);\n\n    bs.registerCleanupTask(function () {\n        clearInterval(int);\n    });\n};\n\n\n/**\n * Use heart-beated data to decorate clients\n * @param clients\n * @param clientsInfo\n * @returns {*}\n */\nfunction decorateClients(clients, clientsInfo) {\n    return clients.map(function (item) {\n        clientsInfo.forEach(function (client) {\n            if (client.id === item.id) {\n                item.data = client.data;\n                return false;\n            }\n        });\n        return item;\n    });\n}\n\n/**\n * @param socket\n * @param connectedClients\n */\nfunction sendUpdated(socket, connectedClients) {\n    socket.emit(\"ui:connections:update\", connectedClients);\n}\n\n/**\n * @param clients\n * @param data\n */\n//function highlightClient (clients, data) {\n//    var socket = getClientById(clients, data.id);\n//    if (socket) {\n//        socket.emit(\"highlight\");\n//    }\n//}\n\n/**\n * @param clients\n * @param id\n */\n//function getClientById (clients, id) {\n//    var match;\n//    clients.sockets.some(function (item, i) {\n//        if (item.id === id) {\n//            match = clients.sockets[i];\n//            return true;\n//        }\n//    });\n//    return match;\n//}"],"mappings":"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"},"metadata":{},"sourceType":"script"}