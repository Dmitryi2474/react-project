{"ast":null,"code":"\"use strict\";\n\nvar enableDestroy = require(\"server-destroy\");\nvar _ = require(\"../lodash.custom\");\n/**\n * Browsersync server\n * Three available modes: Snippet, Server or Proxy\n */\nmodule.exports.plugin = function (bs) {\n  var debug = bs.debug;\n  var proxy = bs.options.get(\"proxy\");\n  var type = bs.options.get(\"mode\");\n  var bsServer = createServer(bs);\n  if (type === \"server\" || type === \"snippet\") {\n    debug(\"Static Server running ({magenta:%s}) ...\", bs.options.get(\"scheme\"));\n  }\n  if (proxy) {\n    debug(\"Proxy running, proxing: {magenta:%s}\", proxy.get(\"target\"));\n  }\n  if (bsServer) {\n    /**\n     * Allow server to be destroyed gracefully\n     */\n    enableDestroy(bsServer.server);\n    /**\n     * Listen on the available port\n     */\n    bsServer.server.listen(bs.options.get(\"port\"), bs.options.get(\"listen\"));\n    /**\n     * Hack to deal with https://github.com/socketio/socket.io/issues/1602#issuecomment-224270022\n     */\n    bs.registerCleanupTask(function () {\n      if (bs.io && bs.io.sockets) {\n        setCloseReceived(bs.io.sockets);\n      }\n      if (bs.ui && bs.ui.socket) {\n        setCloseReceived(bs.ui.socket);\n      }\n    });\n    /**\n     * Destroy the server on cleanup\n     */\n    bs.registerCleanupTask(function () {\n      bsServer.server.destroy();\n    });\n  }\n  function setCloseReceived(io) {\n    Object.keys(io.sockets).forEach(function (key) {\n      _.set(io.sockets[key], \"conn.transport.socket._closeReceived\", true);\n    });\n  }\n  debug(\"Running mode: %s\", type.toUpperCase());\n  return {\n    server: bsServer.server,\n    app: bsServer.app\n  };\n};\n/**\n * Launch the server for serving the client JS plus static files\n * @param {BrowserSync} bs\n * @returns {{staticServer: (http.Server), proxyServer: (http.Server)}}\n */\nfunction createServer(bs) {\n  var proxy = bs.options.get(\"proxy\");\n  var server = bs.options.get(\"server\");\n  if (!proxy && !server) {\n    return require(\"./snippet-server\")(bs);\n  }\n  if (proxy) {\n    return require(\"./proxy-server\")(bs);\n  }\n  if (server) {\n    return require(\"./static-server\")(bs);\n  }\n}\nmodule.exports.createServer = createServer;","map":{"version":3,"mappings":"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","names":["enableDestroy","require","_","module","exports","plugin","bs","debug","proxy","options","get","type","bsServer","createServer","server","listen","registerCleanupTask","io","sockets","setCloseReceived","ui","socket","destroy","Object","keys","forEach","key","set","toUpperCase","app"],"sources":["../../lib/server/index.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}