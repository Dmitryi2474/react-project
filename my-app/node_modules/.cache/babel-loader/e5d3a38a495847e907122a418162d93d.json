{"ast":null,"code":"/**\n * Module dependencies.\n */\n\nvar Transport = require('../transport');\nvar parser = require('engine.io-parser');\nvar util = require('util');\nvar debug = require('debug')('engine:ws');\n\n/**\n * Export the constructor.\n */\n\nmodule.exports = WebSocket;\n\n/**\n * WebSocket transport\n *\n * @param {http.IncomingMessage}\n * @api public\n */\n\nfunction WebSocket(req) {\n  Transport.call(this, req);\n  var self = this;\n  this.socket = req.websocket;\n  this.socket.on('message', this.onData.bind(this));\n  this.socket.once('close', this.onClose.bind(this));\n  this.socket.on('error', this.onError.bind(this));\n  this.socket.on('headers', onHeaders);\n  this.writable = true;\n  this.perMessageDeflate = null;\n  function onHeaders(headers) {\n    self.emit('headers', headers);\n  }\n}\n\n/**\n * Inherits from Transport.\n */\n\nutil.inherits(WebSocket, Transport);\n\n/**\n * Transport name\n *\n * @api public\n */\n\nWebSocket.prototype.name = 'websocket';\n\n/**\n * Advertise upgrade support.\n *\n * @api public\n */\n\nWebSocket.prototype.handlesUpgrades = true;\n\n/**\n * Advertise framing support.\n *\n * @api public\n */\n\nWebSocket.prototype.supportsFraming = true;\n\n/**\n * Processes the incoming data.\n *\n * @param {String} encoded packet\n * @api private\n */\n\nWebSocket.prototype.onData = function (data) {\n  debug('received \"%s\"', data);\n  Transport.prototype.onData.call(this, data);\n};\n\n/**\n * Writes a packet payload.\n *\n * @param {Array} packets\n * @api private\n */\n\nWebSocket.prototype.send = function (packets) {\n  var self = this;\n  for (var i = 0; i < packets.length; i++) {\n    var packet = packets[i];\n    parser.encodePacket(packet, self.supportsBinary, send);\n  }\n  function send(data) {\n    debug('writing \"%s\"', data);\n\n    // always creates a new object since ws modifies it\n    var opts = {};\n    if (packet.options) {\n      opts.compress = packet.options.compress;\n    }\n    if (self.perMessageDeflate) {\n      var len = 'string' === typeof data ? Buffer.byteLength(data) : data.length;\n      if (len < self.perMessageDeflate.threshold) {\n        opts.compress = false;\n      }\n    }\n    self.writable = false;\n    self.socket.send(data, opts, onEnd);\n  }\n  function onEnd(err) {\n    if (err) return self.onError('write error', err.stack);\n    self.writable = true;\n    self.emit('drain');\n  }\n};\n\n/**\n * Closes the transport.\n *\n * @api private\n */\n\nWebSocket.prototype.doClose = function (fn) {\n  debug('closing');\n  this.socket.close();\n  fn && fn();\n};","map":{"version":3,"names":["Transport","require","parser","util","debug","module","exports","WebSocket","req","call","self","socket","websocket","on","onData","bind","once","onClose","onError","onHeaders","writable","perMessageDeflate","headers","emit","inherits","prototype","name","handlesUpgrades","supportsFraming","data","send","packets","i","length","packet","encodePacket","supportsBinary","opts","options","compress","len","Buffer","byteLength","threshold","onEnd","err","stack","doClose","fn","close"],"sources":["/home/user/Рабочий стол/pizza/project/node_modules/engine.io/lib/transports/websocket.js"],"sourcesContent":["\n/**\n * Module dependencies.\n */\n\nvar Transport = require('../transport');\nvar parser = require('engine.io-parser');\nvar util = require('util');\nvar debug = require('debug')('engine:ws');\n\n/**\n * Export the constructor.\n */\n\nmodule.exports = WebSocket;\n\n/**\n * WebSocket transport\n *\n * @param {http.IncomingMessage}\n * @api public\n */\n\nfunction WebSocket (req) {\n  Transport.call(this, req);\n  var self = this;\n  this.socket = req.websocket;\n  this.socket.on('message', this.onData.bind(this));\n  this.socket.once('close', this.onClose.bind(this));\n  this.socket.on('error', this.onError.bind(this));\n  this.socket.on('headers', onHeaders);\n  this.writable = true;\n  this.perMessageDeflate = null;\n\n  function onHeaders (headers) {\n    self.emit('headers', headers);\n  }\n}\n\n/**\n * Inherits from Transport.\n */\n\nutil.inherits(WebSocket, Transport);\n\n/**\n * Transport name\n *\n * @api public\n */\n\nWebSocket.prototype.name = 'websocket';\n\n/**\n * Advertise upgrade support.\n *\n * @api public\n */\n\nWebSocket.prototype.handlesUpgrades = true;\n\n/**\n * Advertise framing support.\n *\n * @api public\n */\n\nWebSocket.prototype.supportsFraming = true;\n\n/**\n * Processes the incoming data.\n *\n * @param {String} encoded packet\n * @api private\n */\n\nWebSocket.prototype.onData = function (data) {\n  debug('received \"%s\"', data);\n  Transport.prototype.onData.call(this, data);\n};\n\n/**\n * Writes a packet payload.\n *\n * @param {Array} packets\n * @api private\n */\n\nWebSocket.prototype.send = function (packets) {\n  var self = this;\n\n  for (var i = 0; i < packets.length; i++) {\n    var packet = packets[i];\n    parser.encodePacket(packet, self.supportsBinary, send);\n  }\n\n  function send (data) {\n    debug('writing \"%s\"', data);\n\n    // always creates a new object since ws modifies it\n    var opts = {};\n    if (packet.options) {\n      opts.compress = packet.options.compress;\n    }\n\n    if (self.perMessageDeflate) {\n      var len = 'string' === typeof data ? Buffer.byteLength(data) : data.length;\n      if (len < self.perMessageDeflate.threshold) {\n        opts.compress = false;\n      }\n    }\n\n    self.writable = false;\n    self.socket.send(data, opts, onEnd);\n  }\n\n  function onEnd (err) {\n    if (err) return self.onError('write error', err.stack);\n    self.writable = true;\n    self.emit('drain');\n  }\n};\n\n/**\n * Closes the transport.\n *\n * @api private\n */\n\nWebSocket.prototype.doClose = function (fn) {\n  debug('closing');\n  this.socket.close();\n  fn && fn();\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}