{"ast":null,"code":"#!/usr/bin/env node\n\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n    return t;\n  };\n  return __assign.apply(this, arguments);\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar startOpts = require(\"../cli-options/opts.start.json\");\nvar reloadOpts = require(\"../cli-options/opts.reload.json\");\nvar recipeOpts = require(\"../cli-options/opts.recipe.json\");\nvar pkg = require(\"../package.json\");\nvar utils = require(\"./utils\");\nvar path_1 = require(\"path\");\nvar fs_1 = require(\"fs\");\nvar logger_1 = require(\"./logger\");\nvar eazy_logger_1 = require(\"eazy-logger\");\nvar cli_options_1 = require(\"./cli/cli-options\");\nvar BsErrorLevels;\n(function (BsErrorLevels) {\n  BsErrorLevels[\"Fatal\"] = \"Fatal\";\n})(BsErrorLevels = exports.BsErrorLevels || (exports.BsErrorLevels = {}));\nvar BsErrorTypes;\n(function (BsErrorTypes) {\n  BsErrorTypes[\"PathNotFound\"] = \"PathNotFound\";\n  BsErrorTypes[\"HostAndListenIncompatible\"] = \"HostAndListenIncompatible\";\n})(BsErrorTypes = exports.BsErrorTypes || (exports.BsErrorTypes = {}));\n/**\n * Handle cli input\n */\nif (!module.parent) {\n  runFromCli();\n}\nfunction runFromCli() {\n  var yargs = require(\"yargs\").command(\"start\", \"Start the server\").command(\"init\", \"Create a configuration file\").command(\"reload\", \"Send a reload event over HTTP protocol\").command(\"recipe\", \"Generate the files for a recipe\").version(function () {\n    return pkg.version;\n  }).epilogue([\"For help running a certain command, type <command> --help\", \"  $0 start --help\", \"\", \"You can run a static server by providing a path(s) directly\", \"  $0 app/src app/tmp\", \"\", \"If the directory contains a 'index.html' file, you can omit any input\", \"  $0\", \"\", \"You can run the proxy in this manner too\", \"  $0 https://example.com\", \"\", \"To run a proxy, whilst also serving static files\", eazy_logger_1.compile(\"  $0 https://example.com htdocs/themes/example\")].join(\"\\n\"));\n  var argv = yargs.argv;\n  var input = argv._;\n  var command = input[0];\n  var valid = [\"start\", \"init\", \"reload\", \"recipe\"];\n  if (valid.indexOf(command) > -1) {\n    return handleIncoming(command, yargs.reset());\n  }\n  if (input.length) {\n    return handleNoCommand(argv, input, yargs);\n  }\n  if (fs_1.existsSync(\"index.html\")) {\n    return handleNoCommand(argv, [\".\"], yargs);\n  }\n  yargs.showHelp();\n}\n/**\n * Feature: If no command was specified, try to do the 'right thing'\n *\n * If paths were given, start the server\n *          eg: browser-sync app/code app/design\n * is equal to: browser-sync start --server app/code app/design\n *\n *           eg: browser-sync http://example.com\n * is equal to: browser-sync start --proxy http://example.com\n *\n *           eg: browser-sync http://example.com themes/example\n * is equal to: browser-sync start --proxy http://example.com --ss themes/example\n *\n * @param argv\n * @param input\n * @returns {any}\n */\nfunction handleNoCommand(argv, input, yargs) {\n  var processed = processStart(yargs);\n  var paths = input.map(function (path) {\n    var resolved = path_1.resolve(path);\n    var isUrl = /^https?:\\/\\//.test(path);\n    return {\n      isUrl: isUrl,\n      userInput: path,\n      resolved: resolved,\n      errors: isUrl ? [] : pathErrors(path, resolved)\n    };\n  });\n  var withErrors = paths.filter(function (item) {\n    return item.errors.length;\n  });\n  var withoutErrors = paths.filter(function (item) {\n    return item.errors.length === 0;\n  });\n  if (withErrors.length) {\n    withErrors.forEach(function (item) {\n      logger_1.logger.unprefixed(\"error\", cli_options_1.printErrors(item.errors));\n    });\n    return process.exit(1);\n  }\n  var serveStaticPaths = withoutErrors.filter(function (item) {\n    return item.isUrl === false;\n  }).map(function (item) {\n    return item.resolved;\n  });\n  var urls = withoutErrors.filter(function (item) {\n    return item.isUrl === true;\n  }).map(function (item) {\n    return item.userInput;\n  });\n  /**\n   * If a URL was given, switch to proxy mode and use\n   * any other paths as serveStatic options\n   */\n  if (urls.length) {\n    var proxy = urls[0];\n    var config_1 = __assign({}, processed, {\n      proxy: proxy,\n      serveStatic: serveStaticPaths\n    });\n    return handleCli({\n      cli: {\n        flags: config_1,\n        input: [\"start\"]\n      }\n    });\n  }\n  /**\n   * if NO urls were given switch directly to server mode\n   * @type {{server: {baseDir: any}}}\n   */\n  var config = __assign({}, processed, {\n    server: {\n      baseDir: serveStaticPaths\n    }\n  });\n  return handleCli({\n    cli: {\n      flags: config,\n      input: [\"start\"]\n    }\n  });\n}\n/**\n * @param {{cli: object, [whitelist]: array, [cb]: function}} opts\n * @returns {*}\n */\nfunction handleCli(opts) {\n  opts.cb = opts.cb || utils.defaultCallback;\n  var m = require(\"./cli/command.\" + opts.cli.input[0]);\n  if (m.default) {\n    return m.default(opts);\n  }\n  return m(opts);\n}\nexports.default = handleCli;\nfunction processStart(yargs) {\n  return yargs.usage(\"Usage: $0 start [options]\").options(startOpts).example(\"$0 start -s app\", \"- Use the App directory to serve files\").example(\"$0 start -p www.bbc.co.uk\", \"- Proxy an existing website\").default('cwd', function () {\n    return process.cwd();\n  }).help().argv;\n}\n/**\n * @param {string} command\n * @param {object} yargs\n * @param cwd\n */\nfunction handleIncoming(command, yargs) {\n  var out;\n  if (command === \"start\") {\n    out = processStart(yargs);\n  }\n  if (command === \"init\") {\n    out = yargs.usage(\"Usage: $0 init\").example(\"$0 init\").default('cwd', function () {\n      return process.cwd();\n    }).help().argv;\n  }\n  if (command === \"reload\") {\n    out = yargs.usage(\"Usage: $0 reload\").options(reloadOpts).example(\"$0 reload\").example(\"$0 reload --port 4000\").default('cwd', function () {\n      return process.cwd();\n    }).help().argv;\n  }\n  if (command === \"recipe\") {\n    out = yargs.usage(\"Usage: $0 recipe <recipe-name>\").option(recipeOpts).example(\"$0 recipe ls\", \"list the recipes\").example(\"$0 recipe gulp.sass\", \"use the gulp.sass recipe\").default('cwd', function () {\n      return process.cwd();\n    }).help().argv;\n  }\n  if (out.help) {\n    return yargs.showHelp();\n  }\n  handleCli({\n    cli: {\n      flags: out,\n      input: out._\n    }\n  });\n}\nfunction pathErrors(input, resolved) {\n  if (!fs_1.existsSync(resolved)) {\n    return [{\n      type: BsErrorTypes.PathNotFound,\n      level: BsErrorLevels.Fatal,\n      errors: [{\n        error: new Error(\"Path not found: \" + input),\n        meta: function () {\n          return [\"Your Input:    {yellow:\" + input + \"}\", \"CWD:           {yellow:\" + process.cwd() + \"}\", \"Resolved to:   {yellow:\" + resolved + \"}\"];\n        }\n      }]\n    }];\n  }\n  return [];\n}","map":{"version":3,"mappings":"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","names":["startOpts","require","reloadOpts","recipeOpts","pkg","BsErrorLevels","exports","BsErrorTypes","module","parent","runFromCli","yargs","command","version","epilogue","eazy_logger_1","join","argv","input","_","valid","indexOf","handleIncoming","reset","length","handleNoCommand","fs_1","showHelp","processed","processStart","paths","map","resolved","path_1","path","isUrl","test","userInput","errors","pathErrors","withErrors","filter","withoutErrors","forEach","logger_1","unprefixed","cli_options_1","item","process","exit","serveStaticPaths","urls","proxy","config_1","serveStatic","handleCli","cli","flags","config","server","baseDir","opts","cb","utils","defaultCallback","m","default","usage","options","example","cwd","help","out","option","type","PathNotFound","level","Fatal","error","Error","meta"],"sources":["../lib/bin.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}