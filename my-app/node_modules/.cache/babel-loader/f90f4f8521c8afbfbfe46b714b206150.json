{"ast":null,"code":"\"use strict\";\n\nvar httpProxy = require(\"http-proxy\");\nvar utils = require(\"./utils\");\nvar proxyUtils = require(\"./proxy-utils\");\nvar Immutable = require(\"immutable\");\nvar Map = require(\"immutable\").Map;\nvar List = require(\"immutable\").List;\n/**\n * Default options that are passed along to http-proxy\n */\nvar defaultHttpProxyOptions = Map({\n  /**\n   * This ensures targets are more likely to\n   * accept each request\n   */\n  changeOrigin: true,\n  /**\n   * This handles redirects\n   */\n  autoRewrite: true,\n  /**\n   * This allows our self-signed certs to be used for development\n   */\n  secure: false,\n  ws: true\n});\nvar defaultCookieOptions = Map({\n  stripDomain: true\n});\nvar ProxyOption = Immutable.Record({\n  route: \"\",\n  target: \"\",\n  rewriteRules: true,\n  /**\n   * Functions to be called on proxy request\n   * with args [proxyReq, req, res, options]\n   */\n  proxyReq: List([]),\n  /**\n   * Functions to be called on proxy response\n   * with args [proxyRes, req, res]\n   */\n  proxyRes: List([]),\n  /**\n   * Functions to be called on proxy response\n   * with args [proxyReq, req, socket, options, head]\n   */\n  proxyReqWs: List([]),\n  errHandler: undefined,\n  url: Map({}),\n  proxyOptions: Map(defaultHttpProxyOptions),\n  cookies: Map(defaultCookieOptions),\n  ws: false,\n  middleware: List([]),\n  reqHeaders: undefined\n});\n/**\n * @param {BrowserSync} bs\n * @param {String} scripts\n * @returns {*}\n */\nmodule.exports = function createProxyServer(bs) {\n  var opt = new ProxyOption().mergeDeep(bs.options.get(\"proxy\"));\n  var proxy = httpProxy.createProxyServer(opt.get(\"proxyOptions\").set(\"target\", opt.get(\"target\")).toJS());\n  var target = opt.get(\"target\");\n  var proxyReq = getProxyReqFunctions(opt.get(\"proxyReq\"), opt, bs);\n  var proxyRes = getProxyResFunctions(opt.get(\"proxyRes\"), opt);\n  var proxyResWs = opt.get(\"proxyReqWs\");\n  bs.options = bs.options.update(\"middleware\", function (mw) {\n    return mw.concat({\n      id: \"Browsersync Proxy\",\n      route: opt.get(\"route\"),\n      handle: function (req, res) {\n        proxy.web(req, res, {\n          target: target\n        });\n      }\n    });\n  });\n  var app = utils.getBaseApp(bs);\n  /**\n   * @type {*|{server, app}}\n   */\n  var browserSyncServer = utils.getServer(app, bs.options);\n  browserSyncServer.proxy = proxy;\n  if (opt.get(\"ws\")) {\n    // debug(`+ ws upgrade for: ${x.get(\"target\")}`);\n    browserSyncServer.server.on(\"upgrade\", function (req, socket, head) {\n      proxy.ws(req, socket, head);\n    });\n  }\n  /**\n   * Add any user provided functions for proxyReq, proxyReqWs and proxyRes\n   */\n  applyFns(\"proxyReq\", proxyReq);\n  applyFns(\"proxyRes\", proxyRes);\n  applyFns(\"proxyReqWs\", proxyResWs);\n  /**\n   * Handle Proxy errors\n   */\n  proxy.on(\"error\", function (err) {\n    if (typeof opt.get(\"errHandler\") === \"function\") {\n      opt.get(\"errHandler\").call(null, err);\n    }\n  });\n  /**\n   * Apply functions to proxy events\n   * @param {string} name - the name of the http-proxy event\n   * @param {Array} fns - functions to call on each event\n   */\n  function applyFns(name, fns) {\n    if (!List.isList(fns)) fns = [fns];\n    proxy.on(name, function () {\n      var args = arguments;\n      fns.forEach(function (fn) {\n        if (typeof fn === \"function\") {\n          fn.apply(null, args);\n        }\n      });\n    });\n  }\n  return browserSyncServer;\n};\n/**\n * @param resFns\n * @returns {*}\n */\nfunction getProxyResFunctions(resFns, opt) {\n  if (opt.getIn([\"cookies\", \"stripDomain\"])) {\n    return resFns.push(proxyUtils.checkCookies);\n  }\n  return resFns;\n}\n/**\n * @param reqFns\n * @returns {*}\n */\nfunction getProxyReqFunctions(reqFns, opt, bs) {\n  var reqHeaders = opt.getIn([\"reqHeaders\"]);\n  if (!reqHeaders) {\n    return reqFns;\n  }\n  /**\n   * Back-compat for old `reqHeaders` option here a\n   * function was given that returned an object\n   * where key:value was header-name:header-value\n   * This didn't really work as it clobbered all other headers,\n   * but it remains for the unlucky few who used it.\n   */\n  if (typeof reqHeaders === \"function\") {\n    var output = reqHeaders.call(bs, opt.toJS());\n    if (Object.keys(output).length) {\n      return reqFns.concat(function (proxyReq) {\n        Object.keys(output).forEach(function (key) {\n          proxyReq.setHeader(key, output[key]);\n        });\n      });\n    }\n  }\n  /**\n   * Now, if {key:value} given, set the each header\n   *\n   * eg: reqHeaders: {\n   *     'is-dev': 'true'\n   * }\n   */\n  if (Map.isMap(reqHeaders)) {\n    return reqFns.concat(function (proxyReq) {\n      reqHeaders.forEach(function (value, key) {\n        proxyReq.setHeader(key, value);\n      });\n    });\n  }\n  return reqFns;\n}","map":{"version":3,"mappings":"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","names":["httpProxy","require","utils","proxyUtils","Immutable","Map","List","defaultHttpProxyOptions","changeOrigin","autoRewrite","secure","ws","defaultCookieOptions","stripDomain","ProxyOption","Record","route","target","rewriteRules","proxyReq","proxyRes","proxyReqWs","errHandler","undefined","url","proxyOptions","cookies","middleware","reqHeaders","module","exports","createProxyServer","bs","opt","mergeDeep","options","get","proxy","set","toJS","getProxyReqFunctions","getProxyResFunctions","proxyResWs","update","mw","concat","id","handle","req","res","web","app","getBaseApp","browserSyncServer","getServer","server","on","socket","head","applyFns","err","call","name","fns","isList","args","arguments","forEach","fn","apply","resFns","getIn","push","checkCookies","reqFns","output","Object","keys","length","key","setHeader","isMap","value"],"sources":["../../lib/server/proxy-server.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}