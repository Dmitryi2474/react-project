{"ast":null,"code":"var http = require(\"http\");\nvar fs = require(\"fs\");\nvar path = require(\"path\");\nvar config = require(\"./config\");\nvar svg = publicFile(config.defaults.public.svg);\nvar indexPage = publicFile(config.defaults.indexPage);\n//var css         = publicFile(config.defaults.public.css);\nvar header = staticFile(config.defaults.components.header);\nvar footer = staticFile(config.defaults.components.footer);\nvar zlib = require(\"zlib\");\n\n/**\n * @param {UI} ui\n * @returns {*}\n */\nfunction startServer(ui) {\n  var connect = ui.bs.utils.connect;\n  var serveStatic = ui.bs.utils.serveStatic;\n\n  /**\n   * Create a connect server\n   */\n  var app = connect();\n  var socketJs = getSocketJs(ui);\n  var jsFilename = \"/\" + md5(socketJs, 10) + \".js\";\n  //var cssFilename = \"/\" + md5(css, 10)   + \".css\";\n\n  /**\n   * Create a single big file with all deps\n   */\n  //app.use(serveFile(jsFilename, \"js\", socketJs));\n  app.use(serveFile(config.defaults.socketJs, \"js\", socketJs));\n\n  // also serve for convenience/testing\n  app.use(serveFile(config.defaults.pagesConfig, \"js\", ui.pagesConfig));\n\n  //\n  app.use(serveFile(config.defaults.clientJs, \"js\", ui.clientJs));\n\n  /**\n   * Add any markup from plugins/hooks/templates\n   */\n  insertPageMarkupFromHooks(app, ui.pages, indexPage.replace(\"%pageMarkup%\", ui.pageMarkup).replace(\"%templates%\", ui.templates).replace(\"%svg%\", svg).replace(\"%header%\", header).replace(/%footer%/g, footer));\n\n  /**\n   * gzip css\n   */\n  //app.use(serveFile(cssFilename, \"css\", css));\n\n  app.use(serveStatic(path.join(__dirname, \"../public\")));\n\n  /**\n   * all public dir as static\n   */\n  app.use(serveStatic(publicDir(\"\")));\n\n  /**\n   * History API fallback\n   */\n  app.use(require(\"connect-history-api-fallback\"));\n\n  /**\n   * Development use\n   */\n  app.use(\"/node_modules\", serveStatic(packageDir(\"node_modules\")));\n\n  /**\n   * Return the server.\n   */\n  return {\n    server: http.createServer(app),\n    app: app\n  };\n}\n\n/**\n * @param app\n * @param pages\n * @param markup\n */\nfunction insertPageMarkupFromHooks(app, pages, markup) {\n  var cached;\n  app.use(function (req, res, next) {\n    if (req.url === \"/\" || pages[req.url.slice(1)]) {\n      res.writeHead(200, {\n        \"Content-Type\": \"text/html\",\n        \"Content-Encoding\": \"gzip\"\n      });\n      if (!cached) {\n        var buf = new Buffer(markup, \"utf-8\");\n        zlib.gzip(buf, function (_, result) {\n          cached = result;\n          res.end(result);\n        });\n      } else {\n        res.end(cached);\n      }\n    } else {\n      next();\n    }\n  });\n}\n\n/**\n * Serve Gzipped files & cache them\n * @param app\n * @param all\n */\nvar gzipCache = {};\nfunction serveFile(path, type, string) {\n  var typemap = {\n    js: \"application/javascript\",\n    css: \"text/css\"\n  };\n  return function (req, res, next) {\n    if (req.url !== path) {\n      return next();\n    }\n    res.writeHead(200, {\n      \"Content-Type\": typemap[type],\n      \"Content-Encoding\": \"gzip\",\n      \"Cache-Control\": \"no-cache, no-store, must-revalidate\",\n      \"Expires\": 0,\n      \"Pragma\": \"no-cache\"\n    });\n    if (gzipCache[path]) {\n      return res.end(gzipCache[path]);\n    }\n    var buf = new Buffer(string, \"utf-8\");\n    zlib.gzip(buf, function (_, result) {\n      gzipCache[path] = result;\n      res.end(result);\n    });\n  };\n}\n\n/**\n * @param cp\n * @returns {string}\n */\nfunction getSocketJs(cp) {\n  return [cp.bs.getExternalSocketConnector({\n    namespace: \"/browser-sync-cp\"\n  })].join(\";\");\n}\n\n///**\n// * @returns {*}\n// * @param filepath\n// */\n//function fileContent (filepath) {\n//    return fs.readFileSync(require.resolve(filepath), \"utf8\");\n//}\n\n/**\n * @param src\n * @param length\n */\nfunction md5(src, length) {\n  var crypto = require(\"crypto\");\n  var hash = crypto.createHash(\"md5\").update(src, \"utf8\").digest(\"hex\");\n  return hash.slice(0, length);\n}\n\n/**\n * CWD directory helper for static dir\n * @param {string} filepath\n * @returns {string}\n */\nfunction publicDir(filepath) {\n  return path.join(__dirname, \"/../public\" + filepath) || \"\";\n}\n\n/**\n * @param {string} filepath\n * @returns {string|string}\n */\nfunction staticDir(filepath) {\n  return path.join(__dirname, \"/../static\" + filepath) || \"\";\n}\n\n/**\n * @param {string} filepath\n * @returns {*}\n */\nfunction publicFile(filepath) {\n  return fs.readFileSync(publicDir(filepath), \"utf-8\");\n}\n\n/**\n * @param filepath\n * @returns {*}\n */\nfunction staticFile(filepath) {\n  return fs.readFileSync(staticDir(filepath), \"utf-8\");\n}\n\n/**\n * @param {string} filepath\n * @returns {string}\n */\nfunction packageDir(filepath) {\n  return path.join(__dirname, \"/../\" + filepath);\n}\nmodule.exports = startServer;","map":{"version":3,"names":["http","require","fs","path","config","svg","publicFile","defaults","public","indexPage","header","staticFile","components","footer","zlib","startServer","ui","connect","bs","utils","serveStatic","app","socketJs","getSocketJs","jsFilename","md5","use","serveFile","pagesConfig","clientJs","insertPageMarkupFromHooks","pages","replace","pageMarkup","templates","join","__dirname","publicDir","packageDir","server","createServer","markup","cached","req","res","next","url","slice","writeHead","buf","Buffer","gzip","_","result","end","gzipCache","type","string","typemap","js","css","cp","getExternalSocketConnector","namespace","src","length","crypto","hash","createHash","update","digest","filepath","staticDir","readFileSync","module","exports"],"sources":["/home/user/Рабочий стол/pizza/project/node_modules/browser-sync-ui/lib/server.js"],"sourcesContent":["var http        = require(\"http\");\nvar fs          = require(\"fs\");\nvar path        = require(\"path\");\nvar config      = require(\"./config\");\nvar svg         = publicFile(config.defaults.public.svg);\nvar indexPage   = publicFile(config.defaults.indexPage);\n//var css         = publicFile(config.defaults.public.css);\nvar header      = staticFile(config.defaults.components.header);\nvar footer      = staticFile(config.defaults.components.footer);\nvar zlib        = require(\"zlib\");\n\n/**\n * @param {UI} ui\n * @returns {*}\n */\nfunction startServer(ui) {\n\n    var connect     = ui.bs.utils.connect;\n    var serveStatic = ui.bs.utils.serveStatic;\n\n    /**\n     * Create a connect server\n     */\n    var app         = connect();\n    var socketJs    = getSocketJs(ui);\n    var jsFilename  = \"/\" + md5(socketJs, 10) + \".js\";\n    //var cssFilename = \"/\" + md5(css, 10)   + \".css\";\n\n    /**\n     * Create a single big file with all deps\n     */\n    //app.use(serveFile(jsFilename, \"js\", socketJs));\n    app.use(serveFile(config.defaults.socketJs, \"js\", socketJs));\n\n    // also serve for convenience/testing\n    app.use(serveFile(config.defaults.pagesConfig, \"js\", ui.pagesConfig));\n\n    //\n    app.use(serveFile(config.defaults.clientJs, \"js\",    ui.clientJs));\n\n    /**\n     * Add any markup from plugins/hooks/templates\n     */\n    insertPageMarkupFromHooks(\n        app,\n        ui.pages,\n        indexPage\n            .replace(\"%pageMarkup%\", ui.pageMarkup)\n            .replace(\"%templates%\", ui.templates)\n            .replace(\"%svg%\", svg)\n            .replace(\"%header%\", header)\n            .replace(/%footer%/g, footer)\n    );\n\n    /**\n     * gzip css\n     */\n    //app.use(serveFile(cssFilename, \"css\", css));\n\n    app.use(serveStatic(path.join(__dirname, \"../public\")));\n\n    /**\n     * all public dir as static\n     */\n    app.use(serveStatic(publicDir(\"\")));\n\n    /**\n     * History API fallback\n     */\n    app.use(require(\"connect-history-api-fallback\"));\n\n    /**\n     * Development use\n     */\n    app.use(\"/node_modules\", serveStatic(packageDir(\"node_modules\")));\n\n    /**\n     * Return the server.\n     */\n    return {\n        server: http.createServer(app),\n        app: app\n    };\n}\n\n/**\n * @param app\n * @param pages\n * @param markup\n */\nfunction insertPageMarkupFromHooks(app, pages, markup) {\n\n    var cached;\n\n    app.use(function (req, res, next) {\n\n        if (req.url === \"/\" || pages[req.url.slice(1)]) {\n            res.writeHead(200, {\"Content-Type\": \"text/html\", \"Content-Encoding\": \"gzip\"});\n            if (!cached) {\n                var buf = new Buffer(markup, \"utf-8\");\n                zlib.gzip(buf, function (_, result) {\n                    cached = result;\n                    res.end(result);\n                });\n            } else {\n                res.end(cached);\n            }\n        } else {\n            next();\n        }\n    });\n}\n\n/**\n * Serve Gzipped files & cache them\n * @param app\n * @param all\n */\nvar gzipCache = {};\nfunction serveFile(path, type, string) {\n    var typemap = {\n        js:  \"application/javascript\",\n        css: \"text/css\"\n    };\n    return function (req, res, next) {\n        if (req.url !== path) {\n            return next();\n        }\n\n        res.writeHead(200, {\n            \"Content-Type\": typemap[type],\n            \"Content-Encoding\": \"gzip\",\n            \"Cache-Control\": \"no-cache, no-store, must-revalidate\",\n            \"Expires\": 0,\n            \"Pragma\": \"no-cache\"\n        });\n\n        if (gzipCache[path]) {\n            return res.end(gzipCache[path]);\n        }\n        var buf = new Buffer(string, \"utf-8\");\n        zlib.gzip(buf, function (_, result) {\n            gzipCache[path] = result;\n            res.end(result);\n        });\n    };\n}\n\n\n/**\n * @param cp\n * @returns {string}\n */\nfunction getSocketJs (cp) {\n\n    return [\n        cp.bs.getExternalSocketConnector({namespace: \"/browser-sync-cp\"})\n    ].join(\";\");\n}\n\n///**\n// * @returns {*}\n// * @param filepath\n// */\n//function fileContent (filepath) {\n//    return fs.readFileSync(require.resolve(filepath), \"utf8\");\n//}\n\n/**\n * @param src\n * @param length\n */\nfunction md5(src, length) {\n    var crypto = require(\"crypto\");\n    var hash   = crypto.createHash(\"md5\").update(src, \"utf8\").digest(\"hex\");\n    return hash.slice(0, length);\n}\n\n/**\n * CWD directory helper for static dir\n * @param {string} filepath\n * @returns {string}\n */\nfunction publicDir (filepath) {\n    return path.join(__dirname, \"/../public\" + filepath) || \"\";\n}\n\n/**\n * @param {string} filepath\n * @returns {string|string}\n */\nfunction staticDir (filepath) {\n    return path.join(__dirname, \"/../static\" + filepath) || \"\";\n}\n\n/**\n * @param {string} filepath\n * @returns {*}\n */\nfunction publicFile(filepath) {\n    return fs.readFileSync(publicDir(filepath), \"utf-8\");\n}\n\n/**\n * @param filepath\n * @returns {*}\n */\nfunction staticFile(filepath) {\n    return fs.readFileSync(staticDir(filepath), \"utf-8\");\n}\n\n/**\n * @param {string} filepath\n * @returns {string}\n */\nfunction packageDir (filepath) {\n    return path.join(__dirname, \"/../\" + filepath);\n}\n\nmodule.exports = startServer;"],"mappings":"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"},"metadata":{},"sourceType":"script"}