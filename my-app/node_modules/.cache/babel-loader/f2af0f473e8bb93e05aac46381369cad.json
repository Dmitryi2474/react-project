{"ast":null,"code":"var Immutable = require(\"immutable\");\nmodule.exports.init = function (ui) {\n  var optPath = [\"network-throttle\"];\n  var serverOptPath = optPath.concat([\"servers\"]);\n  var listenHost = ui.options.get(\"listen\");\n  ui.servers = {};\n  ui.setOptionIn(optPath, Immutable.fromJS({\n    name: \"network-throttle\",\n    title: \"Network Throttle\",\n    active: false,\n    targets: require(\"./targets\")\n  }));\n  ui.setOptionIn(serverOptPath, Immutable.Map({}));\n\n  /**\n   * @param input\n   * @returns {number}\n   */\n  function getPortArg(input) {\n    input = input.trim();\n    if (input.length && input.match(/\\d{3,5}/)) {\n      input = parseInt(input, 10);\n    } else {\n      input = ui.bs.options.get(\"port\") + 1;\n    }\n    return input;\n  }\n\n  /**\n   * @returns {string}\n   */\n  function getTargetUrl() {\n    return require(\"url\").parse(ui.bs.options.getIn([\"urls\", \"local\"]));\n  }\n  var methods = {\n    /**\n     * @param data\n     */\n    \"server:create\": function (data) {\n      data.port = getPortArg(data.port);\n      data.cb = data.cb || function () {/* noop */};\n\n      /**\n       * @param opts\n       */\n      function saveThrottleInfo(opts) {\n        var urls = getUrls(ui.bs.options.set(\"port\", opts.port).toJS());\n        ui.setOptionIn(serverOptPath.concat([opts.port]), Immutable.fromJS({\n          urls: urls,\n          speed: opts.speed\n        }));\n        setTimeout(function () {\n          ui.socket.emit(\"ui:network-throttle:update\", {\n            servers: ui.getOptionIn(serverOptPath).toJS(),\n            event: \"server:create\"\n          });\n          ui.servers[opts.port] = opts.server;\n          data.cb(null, opts);\n        }, 300);\n      }\n\n      /**\n       * @param err\n       * @param port\n       */\n      function createThrottle(err, port) {\n        var target = getTargetUrl();\n        var args = {\n          port: port,\n          target: target,\n          speed: data.speed\n        };\n        if (ui.bs.getOption(\"scheme\") === \"https\") {\n          var httpsOpts = require(\"browser-sync/lib/server/utils\").getHttpsOptions(ui.bs.options);\n          args.key = httpsOpts.key;\n          args.cert = httpsOpts.cert;\n        }\n        args.server = require(\"./throttle-server\")(args, listenHost);\n        require('server-destroy')(args.server);\n        args.server.listen(port, listenHost);\n        saveThrottleInfo(args);\n      }\n\n      /**\n       * Try for a free port\n       */\n      ui.bs.utils.portscanner.findAPortNotInUse(data.port, data.port + 100, listenHost || \"127.0.0.1\", function (err, port) {\n        if (err) {\n          return createThrottle(err);\n        } else {\n          createThrottle(null, port);\n        }\n      });\n    },\n    /**\n     * @param data\n     */\n    \"server:destroy\": function (data) {\n      if (ui.servers[data.port]) {\n        ui.servers[data.port].destroy();\n        ui.setMany(function (item) {\n          item.deleteIn(serverOptPath.concat([parseInt(data.port, 10)]));\n        });\n        delete ui.servers[data.port];\n      }\n      ui.socket.emit(\"ui:network-throttle:update\", {\n        servers: ui.getOptionIn(serverOptPath).toJS(),\n        event: \"server:destroy\"\n      });\n    },\n    /**\n     * @param event\n     */\n    event: function (event) {\n      methods[event.event](event.data);\n    }\n  };\n  return methods;\n};\n\n/**\n * Get local + external urls with a different port\n * @param opts\n * @returns {List<T>|List<any>}\n */\nfunction getUrls(opts) {\n  var list = [];\n  var bsLocal = require(\"url\").parse(opts.urls.local);\n  list.push([bsLocal.protocol + \"//\", bsLocal.hostname, \":\", opts.port].join(\"\"));\n  if (opts.urls.external) {\n    var external = require(\"url\").parse(opts.urls.external);\n    list.push([bsLocal.protocol + \"//\", external.hostname, \":\", opts.port].join(\"\"));\n  }\n  return Immutable.List(list);\n}","map":{"version":3,"names":["Immutable","require","module","exports","init","ui","optPath","serverOptPath","concat","listenHost","options","get","servers","setOptionIn","fromJS","name","title","active","targets","Map","getPortArg","input","trim","length","match","parseInt","bs","getTargetUrl","parse","getIn","methods","data","port","cb","saveThrottleInfo","opts","urls","getUrls","set","toJS","speed","setTimeout","socket","emit","getOptionIn","event","server","createThrottle","err","target","args","getOption","httpsOpts","getHttpsOptions","key","cert","listen","utils","portscanner","findAPortNotInUse","destroy","setMany","item","deleteIn","list","bsLocal","local","push","protocol","hostname","join","external","List"],"sources":["/home/user/Рабочий стол/pizza/project/node_modules/browser-sync-ui/lib/plugins/network-throttle/network-throttle.js"],"sourcesContent":["var Immutable = require(\"immutable\");\n\nmodule.exports.init = function (ui) {\n\n    var optPath = [\"network-throttle\"];\n    var serverOptPath = optPath.concat([\"servers\"]);\n    var listenHost = ui.options.get(\"listen\");\n    ui.servers  = {};\n\n    ui.setOptionIn(optPath, Immutable.fromJS({\n        name: \"network-throttle\",\n        title: \"Network Throttle\",\n        active: false,\n        targets: require(\"./targets\")\n    }));\n\n    ui.setOptionIn(serverOptPath, Immutable.Map({}));\n\n    /**\n     * @param input\n     * @returns {number}\n     */\n    function getPortArg(input) {\n        input = input.trim();\n        if (input.length && input.match(/\\d{3,5}/)) {\n            input = parseInt(input, 10);\n        } else {\n            input = ui.bs.options.get(\"port\") + 1;\n        }\n        return input;\n    }\n\n    /**\n     * @returns {string}\n     */\n    function getTargetUrl() {\n        return require(\"url\").parse(ui.bs.options.getIn([\"urls\", \"local\"]));\n    }\n\n    var methods = {\n        /**\n         * @param data\n         */\n        \"server:create\": function (data) {\n\n            data.port = getPortArg(data.port);\n            data.cb   = data.cb || function () { /* noop */};\n\n            /**\n             * @param opts\n             */\n            function saveThrottleInfo (opts) {\n\n                var urls = getUrls(ui.bs.options.set(\"port\", opts.port).toJS());\n\n                ui.setOptionIn(serverOptPath.concat([opts.port]), Immutable.fromJS({\n                    urls: urls,\n                    speed: opts.speed\n                }));\n\n                setTimeout(function () {\n\n                    ui.socket.emit(\"ui:network-throttle:update\", {\n                        servers: ui.getOptionIn(serverOptPath).toJS(),\n                        event: \"server:create\"\n                    });\n\n                    ui.servers[opts.port] = opts.server;\n\n                    data.cb(null, opts);\n\n                }, 300);\n\n            }\n\n            /**\n             * @param err\n             * @param port\n             */\n            function createThrottle (err, port) {\n\n                var target = getTargetUrl();\n\n                var args = {\n                    port: port,\n                    target: target,\n                    speed: data.speed\n                };\n\n                if (ui.bs.getOption(\"scheme\") === \"https\") {\n                    var httpsOpts = require(\"browser-sync/lib/server/utils\").getHttpsOptions(ui.bs.options);\n                    args.key  = httpsOpts.key;\n                    args.cert = httpsOpts.cert;\n                }\n\n                args.server = require(\"./throttle-server\")(args, listenHost);\n                require('server-destroy')(args.server);\n                args.server.listen(port, listenHost);\n\n                saveThrottleInfo(args);\n            }\n\n            /**\n             * Try for a free port\n             */\n            ui.bs.utils.portscanner.findAPortNotInUse(data.port, data.port + 100, (listenHost || \"127.0.0.1\"), function (err, port) {\n                if (err) {\n                    return createThrottle(err);\n                } else {\n                    createThrottle(null, port);\n                }\n            });\n        },\n        /**\n         * @param data\n         */\n        \"server:destroy\": function (data) {\n            if (ui.servers[data.port]) {\n                ui.servers[data.port].destroy();\n                ui.setMany(function (item) {\n                    item.deleteIn(serverOptPath.concat([parseInt(data.port, 10)]));\n                });\n                delete ui.servers[data.port];\n            }\n            ui.socket.emit(\"ui:network-throttle:update\", {\n                servers: ui.getOptionIn(serverOptPath).toJS(),\n                event: \"server:destroy\"\n            });\n        },\n        /**\n         * @param event\n         */\n        event: function (event) {\n            methods[event.event](event.data);\n        }\n    };\n\n    return methods;\n};\n\n/**\n * Get local + external urls with a different port\n * @param opts\n * @returns {List<T>|List<any>}\n */\nfunction getUrls (opts) {\n\n    var list    = [];\n\n    var bsLocal = require(\"url\").parse(opts.urls.local);\n\n    list.push([bsLocal.protocol + \"//\", bsLocal.hostname, \":\", opts.port].join(\"\"));\n\n    if (opts.urls.external) {\n        var external = require(\"url\").parse(opts.urls.external);\n        list.push([bsLocal.protocol + \"//\", external.hostname, \":\", opts.port].join(\"\"));\n    }\n\n    return Immutable.List(list);\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}